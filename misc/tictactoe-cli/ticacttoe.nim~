import sequtils, tables, strutils, strformat, random, os, parseopt

# 下一步玩家放置
let NEXT_PLAYER = { "X" : "O", "O" : "X" }.toTable
# 列举所有赢的情况
let WINS = @[ 
  @[0,1,2], 
  @[3,4,5], 
  @[6,7,8], 
  @[0,3,6], 
  @[1,4,7], 
  @[2,5,8], 
  @[0,4,8], 
  @[2,4,6] 
]

randomize()

type
  Board = ref object of RootObj
    list: seq[string]
  Game = ref object of RootObj
    currentPlayer*: string
    board*: Board
    aiPlayer: string
    difficulty*: int


proc newBoard(): Board =
  result = Board()
  result.list = @["0", "1", "2", "3", "4", "5", "6", "7", "8"]
  return result

proc newGame(aiPlayer: string, difficulty: int = 9): Game =
  result = new Game

  result.board = newBoard()
  result.currentPlayer = "X"
  result.aiPlayer = aiPlayer
  result.difficulty = difficulty

proc changePlayer(this: Game) =
  this.currentPlayer = NEXT_PLAYER[this.currentPlayer]

proc done(this: Board): (bool, string) =
  for w in WINS:
    if this.list[w[0]] == this.list[w[1]] and this.list[w[1]] == this.list[w[2]]:
      if this.list[w[0]] == "X":
        return (true, "X")
      elif this.list[w[0]] == "O":
        return (true, "O")
  
  if all(this.list, proc(x: string):bool = x in @["O", "X"]) == true:
    return (true, "tie")
  else:
    return (false, "going")

proc `$`(this: Board): string =
  let rows: seq[seq[string]] = @[this.list[0..2], this.list[3..5], this.list[6..8]]
  for row in rows:
    for cell in row:
      stdout.write(cell & " | ")
    echo("\n--------------")

proc emptySpots(this: Board): seq[int] =
  var emptyindices = newSeq[int]()
  for i in this.list:
    if i.isDigit():
      emptyindices.add(parseInt(i))
  
  result = emptyindices

proc startGame*(this: Game) =
  while true:
    echo this.board
    if this.aiPlayer != this.currentPlayer:
      stdout.write("Enter move:")
      let move = stdin.readLine()
      this.board.list[parseInt($move)] = this.currentPlayer
    this.changePlayer()
    let (done, winner) = this.board.done()
    if done:
      echo this.board
      if winner == "tie":
        echo("TIE")
      else:
        echo "WINNER IS : ", winner
      break

when isMainModule:
  var borad = newBoard()
  echo $borad
  var es = borad.emptySpots()
  echo es
  var game = newGame("X")
  game.startGame()